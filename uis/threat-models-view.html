<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threat Model Graph-of-Graphs - Live Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
        }

        /* Main Layout */
        .container {
            display: flex;
            height: 100vh;
        }

        /* Left Panel - Layer Navigator */
        .layer-nav {
            width: 250px;
            background: #111;
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 20px;
        }

        .layer-nav h3 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 20px;
        }

        .layer-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .layer-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: #6366f1;
        }

        .layer-item.active {
            background: rgba(99, 102, 241, 0.2);
            border-left-color: #6366f1;
        }

        .layer-badge {
            background: #333;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: #999;
        }

        /* Center - Main Visualization */
        .main-view {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(17, 17, 17, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 30px;
            z-index: 100;
        }

        .view-toggles {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .view-btn {
            padding: 8px 16px;
            background: #222;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .view-btn:hover {
            background: #333;
            border-color: #444;
        }

        .view-btn.active {
            background: #6366f1;
            border-color: #6366f1;
        }

        /* Graph Container */
        #graph-container {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
        }

        /* Node Styles */
        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node-circle {
            stroke-width: 2;
            transition: all 0.3s ease;
        }

        .node:hover .node-circle {
            stroke-width: 4;
            filter: drop-shadow(0 0 20px currentColor);
        }

        .node-label {
            font-size: 12px;
            text-anchor: middle;
            pointer-events: none;
            fill: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }

        .risk-indicator {
            font-size: 10px;
            font-weight: bold;
            text-anchor: middle;
            fill: #fff;
        }

        /* Links */
        .link {
            stroke: #333;
            stroke-opacity: 0.6;
            stroke-width: 1;
            transition: all 0.3s ease;
        }

        .link.highlighted {
            stroke: #6366f1;
            stroke-width: 3;
            stroke-opacity: 1;
        }

        /* Right Panel - Details */
        .details-panel {
            position: absolute;
            right: -400px;
            top: 60px;
            bottom: 0;
            width: 400px;
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid #333;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 30px;
        }

        .details-panel.active {
            right: 0;
        }

        .close-details {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-details:hover {
            color: #fff;
        }

        /* Threat Cards */
        .threat-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .threat-card:hover {
            border-color: #444;
            background: #222;
        }

        .threat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .threat-name {
            font-weight: 600;
            font-size: 16px;
        }

        .threat-category {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background: #333;
            color: #999;
        }

        .threat-category.compromise { background: rgba(220, 38, 38, 0.2); color: #ef4444; }
        .threat-category.data-breach { background: rgba(234, 88, 12, 0.2); color: #f97316; }
        .threat-category.availability { background: rgba(250, 204, 21, 0.2); color: #facc15; }
        .threat-category.integrity { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .threat-category.compliance { background: rgba(34, 197, 94, 0.2); color: #22c55e; }

        .threat-description {
            color: #999;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .threat-id {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
            font-family: monospace;
        }

        /* Risk Scores */
        .risk-scores {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .risk-score-item {
            background: #111;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .risk-score-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .risk-score-value {
            font-size: 24px;
            font-weight: 700;
        }

        /* Controls */
        .control-item {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .control-name {
            font-weight: 500;
            font-size: 14px;
        }

        .control-type {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.2);
            color: #8b5cf6;
            margin-left: 8px;
        }

        .effectiveness {
            font-size: 12px;
            color: #6366f1;
        }

        .mitigates {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        /* Node Info Header */
        .node-info {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .node-meta {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .meta-item {
            font-size: 12px;
            padding: 4px 12px;
            background: #222;
            border: 1px solid #333;
            border-radius: 16px;
            color: #999;
        }

        /* Floating Stats */
        .floating-stats {
            position: absolute;
            bottom: 30px;
            left: 30px;
            background: rgba(17, 17, 17, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            min-width: 300px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Loading Animation */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
        }

        .error-message h3 {
            color: #ef4444;
            margin-bottom: 12px;
        }

        .error-message p {
            color: #999;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Animated Background Grid */
        .bg-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(99, 102, 241, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99, 102, 241, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: grid-move 20s linear infinite;
            pointer-events: none;
        }

        @keyframes grid-move {
            to { transform: translate(50px, 50px); }
        }

        /* Risk Matrix View */
        .risk-matrix {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 600px;
            display: none;
        }

        .risk-matrix.active {
            display: block;
        }

        .matrix-grid {
            display: grid;
            grid-template-columns: 60px repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr) 60px;
            gap: 2px;
            height: 100%;
        }

        .matrix-cell {
            background: #1a1a1a;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .matrix-label {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .matrix-threat-dot {
            width: 8px;
            height: 8px;
            background: #6366f1;
            border-radius: 50%;
            margin: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .matrix-threat-dot:hover {
            transform: scale(1.5);
            box-shadow: 0 0 10px currentColor;
        }

        /* List View */
        .list-view {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            height: calc(100vh - 150px);
            display: none;
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid #333;
            border-radius: 12px;
        }

        .list-view.active {
            display: block;
        }

        .list-container {
            padding: 20px;
            height: 100%;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .list-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .list-filters {
            display: flex;
            gap: 10px;
        }

        .list-filters select {
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #222;
            color: #fff;
            font-size: 14px;
        }

        .list-content {
            height: calc(100% - 80px);
            overflow-y: auto;
            padding-right: 10px;
        }

        .list-item {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            background: #222;
            border-color: #444;
        }

        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .list-item-title {
            font-weight: 600;
            font-size: 16px;
            color: #fff;
        }

        .list-item-layer {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background: #333;
            color: #999;
        }

        .list-item-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #999;
        }

        .list-item-risk {
            font-weight: 600;
        }

        /* Raw JSON View */
        .json-view {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            height: calc(100vh - 150px);
            display: none;
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid #333;
            border-radius: 12px;
        }

        .json-view.active {
            display: block;
        }

        .json-container {
            padding: 20px;
            height: 100%;
        }

        .json-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .json-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .json-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .json-controls select {
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #222;
            color: #fff;
            font-size: 14px;
        }

        .json-controls .copy-btn {
            padding: 8px 16px;
            background: #6366f1;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .json-controls .copy-btn:hover {
            background: #5855eb;
        }

        .json-content {
            height: calc(100% - 80px);
            overflow: auto;
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #e5e5e5;
            white-space: pre;
        }

        /* Text Description View */
        .text-view {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            height: calc(100vh - 150px);
            display: none;
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid #333;
            border-radius: 12px;
        }

        .text-view.active {
            display: block;
        }

        .text-container {
            padding: 20px;
            height: 100%;
        }

        .text-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .text-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .text-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .text-controls select {
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #222;
            color: #fff;
            font-size: 14px;
        }

        .text-controls .copy-btn {
            padding: 8px 16px;
            background: #6366f1;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .text-controls .copy-btn:hover {
            background: #5855eb;
        }

        .text-controls .export-btn {
            padding: 8px 16px;
            background: #6366f1;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .text-controls .export-btn:hover {
            background: #5855eb;
        }

        .text-content {
            height: calc(100% - 80px);
            overflow: auto;
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #e5e5e5;
            white-space: pre;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Layer Navigator -->
        <div class="layer-nav">
            <h3>System Layers</h3>
            <div class="layer-item" data-layer="customer" data-file="tm-1-customer-layer.json">
                <span>Customer</span>
                <span class="layer-badge">0</span>
            </div>
            <div class="layer-item" data-layer="business" data-file="tm-2-business-layer.json">
                <span>Business Functions</span>
                <span class="layer-badge">0</span>
            </div>
            <div class="layer-item" data-layer="application" data-file="tm-3-application-layer.json">
                <span>Applications</span>
                <span class="layer-badge">0</span>
            </div>
            <div class="layer-item" data-layer="component" data-file="tm-4-component-layer.json">
                <span>Components</span>
                <span class="layer-badge">0</span>
            </div>
            <div class="layer-item" data-layer="package" data-file="tm-5-package-layer.json">
                <span>Packages</span>
                <span class="layer-badge">0</span>
            </div>
            <div class="layer-item" data-layer="class" data-file="tm-6-class-layer.json">
                <span>Classes</span>
                <span class="layer-badge">0</span>
            </div>
            <div class="layer-item" data-layer="method" data-file="tm-7-method-layer.json">
                <span>Methods</span>
                <span class="layer-badge">0</span>
            </div>
            <div class="layer-item" data-layer="code" data-file="tm-8-code-layer.json">
                <span>Source Code</span>
                <span class="layer-badge">0</span>
            </div>
            <div class="layer-item" data-layer="environment" data-file="tm-9-environment-layer.json">
                <span>Environment</span>
                <span class="layer-badge">0</span>
            </div>
            <div class="layer-item" data-layer="runtime" data-file="tm-10-runtime-layer.json">
                <span>Runtime</span>
                <span class="layer-badge">0</span>
            </div>
            <div class="layer-item" data-layer="compute" data-file="tm-11-compute-layer.json">
                <span>Compute</span>
                <span class="layer-badge">0</span>
            </div>
        </div>

        <!-- Main Visualization Area -->
        <div class="main-view">
            <div class="bg-grid"></div>
            
            <!-- Top Bar -->
            <div class="top-bar">
                <h1 style="font-size: 20px; font-weight: 600;">Threat Model Explorer - Live Data</h1>
                <div class="view-toggles">
                    <button class="view-btn active" data-view="graph">Graph View</button>
                    <button class="view-btn" data-view="matrix">Risk Matrix</button>
                    <button class="view-btn" data-view="list">List View</button>
                    <button class="view-btn" data-view="json">Raw JSON</button>
                    <button class="view-btn" data-view="text">Text Description</button>
                </div>
            </div>

            <!-- Graph Container -->
            <div id="graph-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div style="color: #666;">Loading threat models from server...</div>
                </div>
            </div>

            <!-- Risk Matrix View -->
            <div class="risk-matrix" id="riskMatrix">
                <div class="matrix-grid" id="matrixGrid"></div>
            </div>

            <!-- List View -->
            <div class="list-view" id="listView">
                <div class="list-container">
                    <div class="list-header">
                        <h2>Threat Models - List View</h2>
                        <div class="list-filters">
                            <select id="layerFilter">
                                <option value="">All Layers</option>
                            </select>
                            <select id="riskFilter">
                                <option value="">All Risk Levels</option>
                                <option value="high">High Risk (75%+)</option>
                                <option value="medium">Medium Risk (25-74%)</option>
                                <option value="low">Low Risk (0-24%)</option>
                            </select>
                        </div>
                    </div>
                    <div class="list-content" id="listContent"></div>
                </div>
            </div>

            <!-- Raw JSON View -->
            <div class="json-view" id="jsonView">
                <div class="json-container">
                    <div class="json-header">
                        <h2>Raw JSON Data</h2>
                        <div class="json-controls">
                            <select id="jsonLayerSelect">
                                <option value="">Select Layer</option>
                            </select>
                            <button id="copyJsonBtn" class="copy-btn">Copy to Clipboard</button>
                        </div>
                    </div>
                    <pre class="json-content" id="jsonContent">Select a layer to view its raw JSON data</pre>
                </div>
            </div>

            <!-- Text Description View -->
            <div class="text-view" id="textView">
                <div class="text-container">
                    <div class="text-header">
                        <h2>Threat Model Descriptions</h2>
                        <div class="text-controls">
                            <select id="textLayerSelect">
                                <option value="">Select Layer</option>
                            </select>
                            <button id="copyTextBtn" class="copy-btn">Copy Report</button>
                            <button id="exportTextBtn" class="export-btn">Export PDF</button>
                        </div>
                    </div>
                    <div class="text-content" id="textContent">Select a layer to view detailed threat model descriptions</div>
                </div>
            </div>

            <!-- Floating Stats -->
            <div class="floating-stats">
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalThreats">0</div>
                        <div class="stat-label">Total Threats</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgRisk">0%</div>
                        <div class="stat-label">Avg Risk</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="criticalCount">0</div>
                        <div class="stat-label">Critical</div>
                    </div>
                </div>
            </div>

            <!-- Details Panel -->
            <div class="details-panel" id="detailsPanel">
                <button class="close-details" onclick="closeDetails()">Ã—</button>
                
                <div class="node-info" id="nodeInfo"></div>
                
                <h3 style="margin-bottom: 16px; font-size: 16px;">Threats</h3>
                <div id="threatsList"></div>
                
                <h3 style="margin-top: 30px; margin-bottom: 16px; font-size: 16px;">Security Controls</h3>
                <div id="controlsList"></div>
            </div>
        </div>
    </div>

    <script>
        // URL base for your CORS-enabled server
        const DATA_BASE_URL = 'https://files.diniscruz.ai/s3/json/threat-model-data/';
        
        // Store all loaded threat model data
        let allThreatModels = {};
        let currentLayer = null;
        let graphData = { nodes: [], links: [] };

        // Layer colors
        const layerColors = {
            customer: '#6366f1',
            business: '#1e3a8a',
            application: '#6b21a8',
            component: '#be185d',
            package: '#ea580c',
            class: '#dc2626',
            method: '#ca8a04',
            code: '#84cc16',
            environment: '#16a34a',
            runtime: '#0891b2',
            compute: '#2563eb'
        };

        // Load threat model data from your server
        async function loadThreatModel(filename) {
            try {
                const response = await fetch(DATA_BASE_URL + filename);
                if (!response.ok) throw new Error(`Failed to load ${filename}`);
                const data = await response.json();
                console.log(`Loaded ${filename}:`, data);
                return data;
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                return null;
            }
        }

        // Load all threat models
        async function loadAllThreatModels() {
            const layers = document.querySelectorAll('.layer-item');
            let totalThreats = 0;
            let totalRisk = 0;
            let criticalCount = 0;
            let nodeCount = 0;

            for (const layer of layers) {
                const filename = layer.dataset.file;
                const layerName = layer.dataset.layer;
                
                const data = await loadThreatModel(filename);
                if (data && data.threatModels) {
                    allThreatModels[layerName] = data;
                    
                    // Update layer badge with node count
                    const badge = layer.querySelector('.layer-badge');
                    badge.textContent = data.threatModels.length;
                    
                    // Calculate statistics
                    data.threatModels.forEach(tm => {
                        nodeCount++;
                        if (tm.threats) {
                            totalThreats += tm.threats.length;
                            tm.threats.forEach(threat => {
                                if (threat.likelihood >= 4 && threat.impact >= 4) {
                                    criticalCount++;
                                }
                            });
                        }
                        if (tm.riskScore) {
                            totalRisk += tm.riskScore.residual || 0;
                        }
                    });
                }
            }

            // Update statistics
            document.getElementById('totalThreats').textContent = totalThreats;
            document.getElementById('avgRisk').textContent = nodeCount > 0 ? Math.round(totalRisk / nodeCount) + '%' : '0%';
            document.getElementById('criticalCount').textContent = criticalCount;

            // Remove loading indicator
            document.querySelector('.loading').style.display = 'none';
            
            // Load first layer by default
            loadLayer('business');
        }

        // Load specific layer
        function loadLayer(layerName) {
            const layerData = allThreatModels[layerName];
            if (!layerData || !layerData.threatModels) return;

            currentLayer = layerName;
            
            // Update active layer in navigation
            document.querySelectorAll('.layer-item').forEach(item => {
                item.classList.toggle('active', item.dataset.layer === layerName);
            });

            // Convert threat models to graph nodes
            graphData.nodes = layerData.threatModels.map((tm, index) => ({
                id: tm.nodeId,
                name: tm.nodeInfo,
                layer: layerName,
                threatModel: tm,
                x: 300 + (index % 3) * 200,
                y: 200 + Math.floor(index / 3) * 150
            }));

            // Create some sample links based on the original graph structure
            graphData.links = [];
            
            // Update visualization
            updateGraph();
        }

        // Update graph visualization
        function updateGraph() {
            // Clear existing graph
            d3.select('#graph-container svg').remove();
            
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select('#graph-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.5, 3])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            const g = svg.append('g');

            // Create force simulation
            const simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(50))
                .force('x', d3.forceX(width / 2).strength(0.1))
                .force('y', d3.forceY(height / 2).strength(0.1));

            // Add boundary constraints to keep nodes on screen
            simulation.on('tick', () => {
                // Constrain nodes within viewport boundaries
                graphData.nodes.forEach(d => {
                    const radius = 30; // Node radius + some padding
                    d.x = Math.max(radius, Math.min(width - radius, d.x));
                    d.y = Math.max(radius, Math.min(height - radius, d.y));
                });

                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Create links
            const link = g.append('g')
                .selectAll('line')
                .data(graphData.links)
                .enter().append('line')
                .attr('class', 'link');

            // Create nodes
            const node = g.append('g')
                .selectAll('g')
                .data(graphData.nodes)
                .enter().append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add circles to nodes
            node.append('circle')
                .attr('class', 'node-circle')
                .attr('r', d => {
                    const threats = d.threatModel.threats ? d.threatModel.threats.length : 0;
                    return 25 + threats * 3;
                })
                .attr('fill', d => layerColors[d.layer])
                .attr('stroke', d => layerColors[d.layer])
                .on('click', showNodeDetails);

            // Add risk score indicator
            node.append('text')
                .attr('class', 'risk-indicator')
                .attr('dy', 0)
                .text(d => d.threatModel.riskScore ? d.threatModel.riskScore.residual : '');

            // Add labels to nodes
            node.append('text')
                .attr('class', 'node-label')
                .attr('dy', 45)
                .text(d => {
                    // Truncate long names
                    const name = d.name || d.id;
                    return name.length > 20 ? name.substring(0, 20) + '...' : name;
                });

            // Drag functions
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        // Show node details with real threat model data
        function showNodeDetails(event, d) {
            const panel = document.getElementById('detailsPanel');
            const nodeInfo = document.getElementById('nodeInfo');
            const threatsList = document.getElementById('threatsList');
            const controlsList = document.getElementById('controlsList');
            
            const tm = d.threatModel;

            // Node information
            nodeInfo.innerHTML = `
                <h2 style="margin-bottom: 12px;">${tm.nodeInfo}</h2>
                <div style="font-size: 14px; color: #666; margin-bottom: 12px;">Node ID: ${tm.nodeId}</div>
                <div class="risk-scores">
                    <div class="risk-score-item">
                        <div class="risk-score-label">Inherent Risk</div>
                        <div class="risk-score-value" style="color: ${getRiskColor(tm.riskScore.inherent)};">${tm.riskScore.inherent}%</div>
                    </div>
                    <div class="risk-score-item">
                        <div class="risk-score-label">Residual Risk</div>
                        <div class="risk-score-value" style="color: ${getRiskColor(tm.riskScore.residual)};">${tm.riskScore.residual}%</div>
                    </div>
                </div>
                <div class="node-meta">
                    ${tm.metadata.owner ? `<span class="meta-item">Owner: ${tm.metadata.owner}</span>` : ''}
                    ${tm.metadata.compliance ? tm.metadata.compliance.map(c => `<span class="meta-item">${c}</span>`).join('') : ''}
                    ${tm.riskScore.trend ? `<span class="meta-item">Trend: ${tm.riskScore.trend}</span>` : ''}
                </div>
            `;

            // Threats
            threatsList.innerHTML = tm.threats.map(threat => `
                <div class="threat-card">
                    <div class="threat-id">${threat.id}</div>
                    <div class="threat-header">
                        <span class="threat-name">${threat.name}</span>
                        <span class="threat-category ${threat.category}">${threat.category.toUpperCase()}</span>
                    </div>
                    <p class="threat-description">${threat.description}</p>
                    <div class="risk-scores">
                        <div class="risk-score-item">
                            <div class="risk-score-label">Likelihood</div>
                            <div class="risk-score-value" style="color: ${getLikelihoodColor(threat.likelihood)};">${threat.likelihood}/5</div>
                        </div>
                        <div class="risk-score-item">
                            <div class="risk-score-label">Impact</div>
                            <div class="risk-score-value" style="color: ${getImpactColor(threat.impact)};">${threat.impact}/5</div>
                        </div>
                    </div>
                    ${threat.cve ? `<div style="margin-top: 8px; font-size: 12px; color: #f97316;">CVE: ${threat.cve}</div>` : ''}
                </div>
            `).join('');

            // Controls
            controlsList.innerHTML = tm.controls.map(control => `
                <div class="control-item">
                    <div class="control-header">
                        <div>
                            <span class="control-name">${control.name}</span>
                            <span class="control-type">${control.type || 'control'}</span>
                        </div>
                        <span class="effectiveness">${control.effectiveness}% effective</span>
                    </div>
                    ${control.mitigates ? `<div class="mitigates">Mitigates: ${control.mitigates.join(', ')}</div>` : ''}
                </div>
            `).join('');

            panel.classList.add('active');
        }

        // Helper functions for color coding
        function getRiskColor(score) {
            if (score >= 75) return '#ef4444';
            if (score >= 50) return '#f97316';
            if (score >= 25) return '#facc15';
            return '#22c55e';
        }

        function getLikelihoodColor(score) {
            if (score >= 4) return '#ef4444';
            if (score >= 3) return '#f97316';
            if (score >= 2) return '#facc15';
            return '#22c55e';
        }

        function getImpactColor(score) {
            return getLikelihoodColor(score); // Same scale
        }

        // Close details panel
        function closeDetails() {
            document.getElementById('detailsPanel').classList.remove('active');
        }

        // Layer navigation
        document.querySelectorAll('.layer-item').forEach(item => {
            item.addEventListener('click', function() {
                const layerName = this.dataset.layer;
                loadLayer(layerName);
                
                // If JSON view is active, also update the JSON display
                if (document.getElementById('jsonView').classList.contains('active')) {
                    document.getElementById('jsonLayerSelect').value = layerName;
                    displaySelectedLayerJson();
                }
                
                // If Text view is active, also update the text display
                if (document.getElementById('textView').classList.contains('active')) {
                    document.getElementById('textLayerSelect').value = layerName;
                    displaySelectedLayerText();
                }
            });
        });

        // View toggles
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const view = this.dataset.view;
                if (view === 'matrix') {
                    showRiskMatrix();
                } else if (view === 'graph') {
                    showGraphView();
                } else if (view === 'list') {
                    showListView();
                } else if (view === 'json') {
                    showRawJsonView();
                } else if (view === 'text') {
                    showTextDescription();
                }
            });
        });

        // View functions
        function showGraphView() {
            document.getElementById('graph-container').style.display = 'block';
            document.getElementById('riskMatrix').classList.remove('active');
            document.getElementById('listView').classList.remove('active');
            document.getElementById('jsonView').classList.remove('active');
            document.getElementById('textView').classList.remove('active');
        }

        function showRiskMatrix() {
            document.getElementById('graph-container').style.display = 'none';
            document.getElementById('riskMatrix').classList.add('active');
            document.getElementById('listView').classList.remove('active');
            document.getElementById('jsonView').classList.remove('active');
            document.getElementById('textView').classList.remove('active');
            buildRiskMatrix();
        }

        function showListView() {
            document.getElementById('graph-container').style.display = 'none';
            document.getElementById('riskMatrix').classList.remove('active');
            document.getElementById('listView').classList.add('active');
            document.getElementById('jsonView').classList.remove('active');
            document.getElementById('textView').classList.remove('active');
            buildListView();
        }

        function showRawJsonView() {
            document.getElementById('graph-container').style.display = 'none';
            document.getElementById('riskMatrix').classList.remove('active');
            document.getElementById('listView').classList.remove('active');
            document.getElementById('jsonView').classList.add('active');
            document.getElementById('textView').classList.remove('active');
            buildRawJsonView();
        }

        function showTextDescription() {
            document.getElementById('graph-container').style.display = 'none';
            document.getElementById('riskMatrix').classList.remove('active');
            document.getElementById('listView').classList.remove('active');
            document.getElementById('jsonView').classList.remove('active');
            document.getElementById('textView').classList.add('active');
            buildTextDescription();
        }

        // Risk Matrix functions
        function buildRiskMatrix() {
            const grid = document.getElementById('matrixGrid');
            grid.innerHTML = '';
            
            // Create 5x5 grid with labels
            for (let impact = 5; impact >= 1; impact--) {
                // Impact label
                const impactLabel = document.createElement('div');
                impactLabel.className = 'matrix-label';
                impactLabel.textContent = impact === 5 ? '5 High' : impact === 1 ? '1 Low' : impact;
                grid.appendChild(impactLabel);
                
                // Cells
                for (let likelihood = 1; likelihood <= 5; likelihood++) {
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell';
                    cell.dataset.likelihood = likelihood;
                    cell.dataset.impact = impact;
                    
                    // Color based on risk level
                    const riskLevel = likelihood * impact;
                    if (riskLevel >= 20) cell.style.backgroundColor = 'rgba(220, 38, 38, 0.2)';
                    else if (riskLevel >= 12) cell.style.backgroundColor = 'rgba(234, 88, 12, 0.2)';
                    else if (riskLevel >= 6) cell.style.backgroundColor = 'rgba(250, 204, 21, 0.2)';
                    else cell.style.backgroundColor = 'rgba(34, 197, 94, 0.2)';
                    
                    grid.appendChild(cell);
                }
            }
            
            // Likelihood labels
            const emptyCorner = document.createElement('div');
            grid.appendChild(emptyCorner);
            
            for (let i = 1; i <= 5; i++) {
                const likelihoodLabel = document.createElement('div');
                likelihoodLabel.className = 'matrix-label';
                likelihoodLabel.textContent = i === 1 ? '1 Low' : i === 5 ? '5 High' : i;
                grid.appendChild(likelihoodLabel);
            }
            
            // Plot threats on matrix
            Object.values(allThreatModels).forEach(layer => {
                if (layer.threatModels) {
                    layer.threatModels.forEach(tm => {
                        if (tm.threats) {
                            tm.threats.forEach(threat => {
                                const cell = grid.querySelector(`[data-likelihood="${threat.likelihood}"][data-impact="${threat.impact}"]`);
                                if (cell) {
                                    const dot = document.createElement('div');
                                    dot.className = 'matrix-threat-dot';
                                    dot.style.background = layerColors[layer.layer];
                                    dot.title = `${tm.nodeInfo}: ${threat.name}`;
                                    
                                    // Store threat model data for click handling
                                    dot.threatModelData = {
                                        threatModel: tm,
                                        layer: layer.layer,
                                        name: tm.nodeInfo || tm.nodeId,
                                        id: tm.nodeId
                                    };
                                    
                                    // Add click event listener
                                    dot.addEventListener('click', function(event) {
                                        event.stopPropagation();
                                        showNodeDetails(event, this.threatModelData);
                                    });
                                    
                                    cell.appendChild(dot);
                                }
                            });
                        }
                    });
                }
            });
        }

        // List View functions
        function buildListView() {
            populateLayerFilters();
            filterAndDisplayList();
            
            // Add event listeners for filters
            document.getElementById('layerFilter').addEventListener('change', filterAndDisplayList);
            document.getElementById('riskFilter').addEventListener('change', filterAndDisplayList);
        }

        function populateLayerFilters() {
            const layerFilter = document.getElementById('layerFilter');
            layerFilter.innerHTML = '<option value="">All Layers</option>';
            
            Object.keys(allThreatModels).forEach(layerName => {
                const option = document.createElement('option');
                option.value = layerName;
                option.textContent = layerName.charAt(0).toUpperCase() + layerName.slice(1);
                layerFilter.appendChild(option);
            });
        }

        function filterAndDisplayList() {
            const layerFilter = document.getElementById('layerFilter').value;
            const riskFilter = document.getElementById('riskFilter').value;
            const listContent = document.getElementById('listContent');
            
            listContent.innerHTML = '';
            
            Object.entries(allThreatModels).forEach(([layerName, layerData]) => {
                if (layerFilter && layerFilter !== layerName) return;
                
                if (layerData && layerData.threatModels) {
                    layerData.threatModels.forEach(tm => {
                        // Apply risk filter
                        if (riskFilter) {
                            const risk = tm.riskScore ? tm.riskScore.residual : 0;
                            if (riskFilter === 'high' && risk < 75) return;
                            if (riskFilter === 'medium' && (risk < 25 || risk >= 75)) return;
                            if (riskFilter === 'low' && risk >= 25) return;
                        }
                        
                        const threatCount = tm.threats ? tm.threats.length : 0;
                        const controlCount = tm.controls ? tm.controls.length : 0;
                        const riskScore = tm.riskScore ? tm.riskScore.residual : 0;
                        
                        const listItem = document.createElement('div');
                        listItem.className = 'list-item';
                        listItem.onclick = () => showNodeDetailsFromList(tm, layerName);
                        
                        listItem.innerHTML = `
                            <div class="list-item-header">
                                <div class="list-item-title">${tm.nodeInfo || tm.nodeId}</div>
                                <div class="list-item-layer" style="background: ${layerColors[layerName]}20; color: ${layerColors[layerName]};">${layerName.toUpperCase()}</div>
                            </div>
                            <div class="list-item-stats">
                                <span>Threats: <strong>${threatCount}</strong></span>
                                <span>Controls: <strong>${controlCount}</strong></span>
                                <span class="list-item-risk" style="color: ${getRiskColor(riskScore)};">Risk: <strong>${riskScore}%</strong></span>
                            </div>
                        `;
                        
                        listContent.appendChild(listItem);
                    });
                }
            });
        }

        function showNodeDetailsFromList(threatModel, layerName) {
            // Create a mock node object for compatibility with existing showNodeDetails function
            const mockNode = {
                threatModel: threatModel,
                layer: layerName,
                name: threatModel.nodeInfo || threatModel.nodeId,
                id: threatModel.nodeId
            };
            
            showNodeDetails(null, mockNode);
        }

        // Raw JSON View functions
        function buildRawJsonView() {
            populateJsonLayerSelect();
            
            // If there's a current layer selected, auto-select it in the JSON view
            if (currentLayer) {
                document.getElementById('jsonLayerSelect').value = currentLayer;
                displaySelectedLayerJson();
            }
            
            // Add event listener for layer selection
            document.getElementById('jsonLayerSelect').addEventListener('change', displaySelectedLayerJson);
            
            // Add event listener for copy button
            document.getElementById('copyJsonBtn').addEventListener('click', copyJsonToClipboard);
        }

        function populateJsonLayerSelect() {
            const jsonLayerSelect = document.getElementById('jsonLayerSelect');
            jsonLayerSelect.innerHTML = '<option value="">Select Layer</option>';
            
            Object.keys(allThreatModels).forEach(layerName => {
                const option = document.createElement('option');
                option.value = layerName;
                option.textContent = layerName.charAt(0).toUpperCase() + layerName.slice(1);
                jsonLayerSelect.appendChild(option);
            });
        }

        function displaySelectedLayerJson() {
            const selectedLayer = document.getElementById('jsonLayerSelect').value;
            const jsonContent = document.getElementById('jsonContent');
            
            if (!selectedLayer || !allThreatModels[selectedLayer]) {
                jsonContent.textContent = 'Select a layer to view its raw JSON data';
                return;
            }
            
            try {
                const formattedJson = JSON.stringify(allThreatModels[selectedLayer], null, 2);
                jsonContent.textContent = formattedJson;
            } catch (error) {
                jsonContent.textContent = 'Error formatting JSON: ' + error.message;
            }
        }

        async function copyJsonToClipboard() {
            const jsonContent = document.getElementById('jsonContent').textContent;
            const copyBtn = document.getElementById('copyJsonBtn');
            
            if (!jsonContent || jsonContent === 'Select a layer to view its raw JSON data') {
                alert('Please select a layer first');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(jsonContent);
                copyBtn.textContent = 'Copied!';
                copyBtn.style.background = '#22c55e';
                
                setTimeout(() => {
                    copyBtn.textContent = 'Copy to Clipboard';
                    copyBtn.style.background = '#6366f1';
                }, 2000);
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                alert('Failed to copy to clipboard');
            }
        }

        // Text Description View functions
        function buildTextDescription() {
            populateTextLayerSelect();
            
            // If there's a current layer selected, auto-select it in the text view
            if (currentLayer) {
                document.getElementById('textLayerSelect').value = currentLayer;
                displaySelectedLayerText();
            }
            
            // Add event listener for layer selection
            document.getElementById('textLayerSelect').addEventListener('change', displaySelectedLayerText);
            
            // Add event listener for copy button
            document.getElementById('copyTextBtn').addEventListener('click', copyTextToClipboard);
            
            // Add event listener for export button
            document.getElementById('exportTextBtn').addEventListener('click', exportTextReport);
        }

        function populateTextLayerSelect() {
            const textLayerSelect = document.getElementById('textLayerSelect');
            textLayerSelect.innerHTML = '<option value="">Select Layer</option>';
            
            Object.keys(allThreatModels).forEach(layerName => {
                const option = document.createElement('option');
                option.value = layerName;
                option.textContent = layerName.charAt(0).toUpperCase() + layerName.slice(1);
                textLayerSelect.appendChild(option);
            });
        }

        function displaySelectedLayerText() {
            const selectedLayer = document.getElementById('textLayerSelect').value;
            const textContent = document.getElementById('textContent');
            
            if (!selectedLayer || !allThreatModels[selectedLayer]) {
                textContent.textContent = 'Select a layer to view detailed threat model descriptions';
                return;
            }
            
            try {
                const layerData = allThreatModels[selectedLayer];
                const textReport = generateThreatModelReport(layerData, selectedLayer);
                textContent.textContent = textReport;
            } catch (error) {
                textContent.textContent = 'Error generating report: ' + error.message;
            }
        }

        function generateThreatModelReport(layerData, layerName) {
            let report = '';
            
            // Header
            report += `THREAT MODEL REPORT\n`;
            report += `===================\n\n`;
            report += `Layer: ${layerName.toUpperCase()}\n`;
            report += `Description: ${layerData.description || 'Threat models for ' + layerName + ' layer components'}\n`;
            report += `Generated: ${new Date().toLocaleString()}\n`;
            report += `Total Components: ${layerData.threatModels ? layerData.threatModels.length : 0}\n\n`;
            
            if (!layerData.threatModels || layerData.threatModels.length === 0) {
                report += `No threat models found for this layer.\n`;
                return report;
            }
            
            // Executive Summary
            const stats = calculateLayerStats(layerData.threatModels);
            report += `EXECUTIVE SUMMARY\n`;
            report += `=================\n\n`;
            report += `This report analyzes ${stats.totalNodes} components in the ${layerName} layer.\n`;
            report += `A total of ${stats.totalThreats} threats have been identified across all components,\n`;
            report += `with ${stats.totalControls} security controls implemented to mitigate these risks.\n\n`;
            report += `Risk Distribution:\n`;
            report += `- High Risk (75%+): ${stats.highRisk} components\n`;
            report += `- Medium Risk (25-74%): ${stats.mediumRisk} components\n`;
            report += `- Low Risk (0-24%): ${stats.lowRisk} components\n\n`;
            report += `Average residual risk across the layer: ${stats.avgResidualRisk}%\n\n`;
            
            // Detailed Component Analysis
            report += `DETAILED COMPONENT ANALYSIS\n`;
            report += `===========================\n\n`;
            
            layerData.threatModels.forEach((tm, index) => {
                report += generateComponentReport(tm, index + 1);
            });
            
            // Recommendations
            report += generateRecommendations(layerData.threatModels, layerName);
            
            return report;
        }

        function calculateLayerStats(threatModels) {
            let totalThreats = 0;
            let totalControls = 0;
            let totalRisk = 0;
            let highRisk = 0;
            let mediumRisk = 0;
            let lowRisk = 0;
            
            threatModels.forEach(tm => {
                totalThreats += tm.threats ? tm.threats.length : 0;
                totalControls += tm.controls ? tm.controls.length : 0;
                
                const residualRisk = tm.riskScore ? tm.riskScore.residual : 0;
                totalRisk += residualRisk;
                
                if (residualRisk >= 75) highRisk++;
                else if (residualRisk >= 25) mediumRisk++;
                else lowRisk++;
            });
            
            return {
                totalNodes: threatModels.length,
                totalThreats,
                totalControls,
                highRisk,
                mediumRisk,
                lowRisk,
                avgResidualRisk: threatModels.length > 0 ? Math.round(totalRisk / threatModels.length) : 0
            };
        }

        function generateComponentReport(tm, componentNum) {
            let report = '';
            
            report += `${componentNum}. ${tm.nodeInfo || tm.nodeId}\n`;
            report += `${'='.repeat((tm.nodeInfo || tm.nodeId).length + 3)}\n\n`;
            
            // Component Overview
            report += `Component ID: ${tm.nodeId}\n`;
            if (tm.metadata?.owner) report += `Owner: ${tm.metadata.owner}\n`;
            if (tm.metadata?.tags) report += `Tags: ${tm.metadata.tags.join(', ')}\n`;
            if (tm.metadata?.lastAssessed) report += `Last Assessed: ${new Date(tm.metadata.lastAssessed).toLocaleDateString()}\n`;
            report += `\n`;
            
            // Risk Assessment
            if (tm.riskScore) {
                report += `Risk Assessment:\n`;
                report += `- Inherent Risk: ${tm.riskScore.inherent}%\n`;
                report += `- Residual Risk: ${tm.riskScore.residual}%\n`;
                report += `- Risk Trend: ${tm.riskScore.trend || 'stable'}\n`;
                report += `- Risk Reduction: ${tm.riskScore.inherent - tm.riskScore.residual}%\n\n`;
            }
            
            // Threats
            if (tm.threats && tm.threats.length > 0) {
                report += `Identified Threats (${tm.threats.length}):\n`;
                tm.threats.forEach((threat, i) => {
                    report += `  ${i + 1}. ${threat.name} [${threat.id}]\n`;
                    report += `     Category: ${threat.category.toUpperCase()}\n`;
                    report += `     Description: ${threat.description}\n`;
                    report += `     Likelihood: ${threat.likelihood}/5, Impact: ${threat.impact}/5\n`;
                    report += `     Risk Score: ${threat.likelihood * threat.impact}/25\n`;
                    if (threat.cve) report += `     CVE: ${threat.cve}\n`;
                    report += `\n`;
                });
            } else {
                report += `No threats identified for this component.\n\n`;
            }
            
            // Controls
            if (tm.controls && tm.controls.length > 0) {
                report += `Security Controls (${tm.controls.length}):\n`;
                tm.controls.forEach((control, i) => {
                    report += `  ${i + 1}. ${control.name} [${control.id}]\n`;
                    report += `     Type: ${control.type || 'preventive'}\n`;
                    report += `     Effectiveness: ${control.effectiveness}%\n`;
                    if (control.mitigates) {
                        report += `     Mitigates: ${control.mitigates.join(', ')}\n`;
                    }
                    report += `\n`;
                });
            } else {
                report += `No security controls defined for this component.\n\n`;
            }
            
            // Component-specific recommendations
            const componentRisk = tm.riskScore ? tm.riskScore.residual : 0;
            if (componentRisk >= 50) {
                report += `âš ï¸  ATTENTION REQUIRED:\n`;
                report += `This component has elevated risk levels. Consider:\n`;
                report += `- Implementing additional security controls\n`;
                report += `- Increasing monitoring and detection capabilities\n`;
                report += `- Regular security assessments\n\n`;
            }
            
            report += `${'-'.repeat(80)}\n\n`;
            
            return report;
        }

        function generateRecommendations(threatModels, layerName) {
            let report = '';
            
            report += `RECOMMENDATIONS\n`;
            report += `===============\n\n`;
            
            // Analyze patterns across all components
            const threatCategories = {};
            const controlTypes = {};
            let highRiskComponents = [];
            
            threatModels.forEach(tm => {
                // Count threat categories
                if (tm.threats) {
                    tm.threats.forEach(threat => {
                        threatCategories[threat.category] = (threatCategories[threat.category] || 0) + 1;
                    });
                }
                
                // Count control types
                if (tm.controls) {
                    tm.controls.forEach(control => {
                        controlTypes[control.type] = (controlTypes[control.type] || 0) + 1;
                    });
                }
                
                // Identify high-risk components
                if (tm.riskScore && tm.riskScore.residual >= 50) {
                    highRiskComponents.push(tm.nodeInfo || tm.nodeId);
                }
            });
            
            // Priority recommendations
            report += `PRIORITY ACTIONS:\n\n`;
            
            if (highRiskComponents.length > 0) {
                report += `1. HIGH-RISK COMPONENTS REQUIRE IMMEDIATE ATTENTION:\n`;
                highRiskComponents.forEach(component => {
                    report += `   - ${component}\n`;
                });
                report += `\n`;
            }
            
            // Most common threats
            const sortedThreats = Object.entries(threatCategories).sort((a, b) => b[1] - a[1]);
            if (sortedThreats.length > 0) {
                report += `2. COMMON THREAT CATEGORIES TO ADDRESS:\n`;
                sortedThreats.slice(0, 3).forEach(([category, count]) => {
                    report += `   - ${category.toUpperCase()}: ${count} instances\n`;
                });
                report += `\n`;
            }
            
            // Control gap analysis
            const sortedControls = Object.entries(controlTypes).sort((a, b) => b[1] - a[1]);
            report += `3. CONTROL EFFECTIVENESS ANALYSIS:\n`;
            if (sortedControls.length > 0) {
                report += `   Current control distribution:\n`;
                sortedControls.forEach(([type, count]) => {
                    report += `   - ${type}: ${count} controls\n`;
                });
            } else {
                report += `   âš ï¸  Limited security controls detected. Consider implementing:\n`;
                report += `   - Preventive controls to reduce likelihood\n`;
                report += `   - Detective controls for early threat detection\n`;
                report += `   - Corrective controls for incident response\n`;
            }
            report += `\n`;
            
            // Layer-specific recommendations
            report += `4. LAYER-SPECIFIC RECOMMENDATIONS:\n`;
            switch (layerName) {
                case 'environment':
                    report += `   - Keep runtime environments updated with latest security patches\n`;
                    report += `   - Implement runtime application self-protection (RASP)\n`;
                    report += `   - Configure secure runtime settings and hardening\n`;
                    break;
                case 'application':
                    report += `   - Implement secure coding practices\n`;
                    report += `   - Regular application security testing (SAST/DAST)\n`;
                    report += `   - Input validation and output encoding\n`;
                    break;
                case 'component':
                    report += `   - Component inventory and vulnerability management\n`;
                    report += `   - Dependency scanning and license compliance\n`;
                    report += `   - Secure component architecture reviews\n`;
                    break;
                default:
                    report += `   - Regular security assessments and reviews\n`;
                    report += `   - Implement defense-in-depth strategies\n`;
                    report += `   - Continuous monitoring and threat detection\n`;
            }
            report += `\n`;
            
            // Compliance and governance
            report += `5. GOVERNANCE AND COMPLIANCE:\n`;
            report += `   - Establish regular threat model review cycles\n`;
            report += `   - Define clear ownership and accountability\n`;
            report += `   - Integrate threat modeling into development lifecycle\n`;
            report += `   - Maintain threat model documentation and updates\n\n`;
            
            report += `END OF REPORT\n`;
            report += `=============\n`;
            
            return report;
        }

        async function copyTextToClipboard() {
            const textContent = document.getElementById('textContent').textContent;
            const copyBtn = document.getElementById('copyTextBtn');
            
            if (!textContent || textContent === 'Select a layer to view detailed threat model descriptions') {
                alert('Please select a layer first');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(textContent);
                copyBtn.textContent = 'Copied!';
                copyBtn.style.background = '#22c55e';
                
                setTimeout(() => {
                    copyBtn.textContent = 'Copy Report';
                    copyBtn.style.background = '#6366f1';
                }, 2000);
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                alert('Failed to copy to clipboard');
            }
        }

        function exportTextReport() {
            const textContent = document.getElementById('textContent').textContent;
            const selectedLayer = document.getElementById('textLayerSelect').value;
            
            if (!textContent || textContent === 'Select a layer to view detailed threat model descriptions') {
                alert('Please select a layer first');
                return;
            }
            
            // Create downloadable text file
            const blob = new Blob([textContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `threat-model-report-${selectedLayer}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Visual feedback
            const exportBtn = document.getElementById('exportTextBtn');
            exportBtn.textContent = 'Exported!';
            exportBtn.style.background = '#22c55e';
            
            setTimeout(() => {
                exportBtn.textContent = 'Export PDF';
                exportBtn.style.background = '#6366f1';
            }, 2000);
        }

        // Initialize the application
        loadAllThreatModels();
    </script>
</body>
</html>